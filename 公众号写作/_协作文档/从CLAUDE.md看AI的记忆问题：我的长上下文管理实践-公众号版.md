# 从CLAUDE.md看AI的"记忆"问题：我的长上下文管理实践

## 开头：AI的"金鱼记忆"

上周有个读者私信我：

> "熊哥，我用Claude写了一套项目规范，结果每次新开对话，它就全忘了。我得反复粘贴同样的内容，烦死了。"

这让我想起半年前的自己。

那时候我刚开始用AI辅助写作，每次开对话都要粘贴一大段"写作规则"：

```
你是一个公众号写作助手，风格要求如下：
1. 口语化表达，不要太书面
2. 多用短句，少用长句
3. 技术内容要讲人话
4. 不要用"首先、其次、最后"这种套话
...
（还有20多条）
```

粘贴完，token就用掉1000多。关键是，**每次都要粘**。

AI的记忆，就像金鱼——游一圈就忘了。

直到我发现了CLAUDE.md。

---

## 为什么LLM需要"外挂记忆"？

在聊CLAUDE.md之前，我想先说清楚一个底层问题：**为什么AI会"失忆"？**

> ### 上下文窗口：有限的工作台

LLM的工作方式，本质上是在一个"上下文窗口"里处理信息。

你可以把它想象成一张工作台：
- Claude 3.5的工作台大约能放20万个token（约15万字）
- GPT-4的工作台大约能放12.8万个token

听起来很大？但实际使用中，这个空间很快就会被填满：
- 系统提示词（system prompt）
- 历史对话记录
- 你上传的代码/文档
- AI的思考过程

**问题来了**：当工作台满了，旧的内容就会被"挤出去"。

这就是为什么长对话到后面，AI会"忘记"你开头说过的话。

> ### 信息衰减：越远越模糊

更麻烦的是，即使在上下文窗口内，信息也不是"平等"的。

研究表明，LLM对信息的"注意力"呈现U型曲线：
- **开头的内容**：记得清楚
- **结尾的内容**：记得清楚
- **中间的内容**：容易被忽略

这就是著名的"Lost in the Middle"问题。

你精心写的项目规范放在对话中间？很可能被AI"选择性遗忘"。

> ### 会话隔离：每次都是新开始

最致命的问题：**不同会话之间，完全隔离**。

今天你和Claude聊了3小时，教会它你的代码风格、项目结构、团队规范。

明天新开一个会话？

抱歉，它完全不记得你是谁。

这就是为什么我们需要"外挂记忆"——让AI在每次对话开始时，自动加载必要的上下文。

---

## CLAUDE.md：Anthropic的解决方案

2025年初，Anthropic在Claude Code中引入了CLAUDE.md机制。

简单说：**它是一个会被自动加载到每次对话的配置文件**。

> ### 四层记忆架构

Claude Code的记忆系统分四层，从高到低：

**1. 企业策略**
- 文件位置：IT管理员配置
- 作用范围：全组织
- 典型用途：安全合规、禁止事项

**2. 项目记忆**
- 文件位置：`./CLAUDE.md`
- 作用范围：当前项目
- 典型用途：架构规范、代码风格

**3. 模块规则**
- 文件位置：`.claude/rules/`
- 作用范围：特定模块
- 典型用途：子目录专属规则

**4. 用户偏好**
- 文件位置：`~/.claude/CLAUDE.md`
- 作用范围：所有项目
- 典型用途：个人习惯、通用偏好

**优先级从高到低**：企业策略 > 项目记忆 > 用户偏好

> ### 我的CLAUDE.md长什么样？

以我的写作项目为例，根目录的CLAUDE.md大概是这样：

```markdown
# 写作项目协作总纲

## 关于熊哥
- AI Native Coder，程序员、AI量化自媒体博主
- 核心风格：实践导向、技术深度、易懂表达、有用可落地

## 协作原则
1. Think Aloud：展示思考过程，不要直接给答案
2. 调研先行：涉及新概念，必须先搜索验证
3. 不编造数据：没有来源的数据不使用

## 工作区路由
- 公众号写作 → 读取 /公众号写作/CLAUDE.md
- 视频创作 → 读取 /视频创作/CLAUDE.md
```

注意几个关键点：

**1. 精简**

整个文件不超过50行。因为CLAUDE.md的内容会被加载到每次对话，太长会浪费token，还会稀释重要信息。

**2. 层级化**

根目录放通用规则，子目录放专属规则。这样Claude在处理公众号任务时，会同时加载根目录和子目录的规则。

**3. 人设定义**

开头就告诉Claude"我是谁"。这不是玄学，是让AI在后续对话中保持一致的输出风格。

> ### 配置的最佳实践

基于官方文档和我的实践，总结几条原则：

**1. Less is More**

官方建议：CLAUDE.md应该尽可能精简，只包含"每次会话都需要"的信息。

```
❌ 不推荐：把所有规则都塞进去
（200行各种细节规则）

✅ 推荐：只保留核心规则，细节用文件引用
## 核心原则
1. 代码风格遵循 @docs/code-style.md
2. API设计参考 @docs/api-guidelines.md
```

**2. 用指针代替内容**

不要在CLAUDE.md里放代码片段，它们很快会过时。用文件路径引用：

```
❌ 不推荐
认证逻辑示例：
function auth() { ... 50行代码 ... }

✅ 推荐
认证逻辑参考：src/auth/index.ts:42
```

**3. 让Linter做Linter的事**

代码风格检查交给ESLint、Prettier这些工具。在CLAUDE.md里写"缩进用2空格"是浪费。

**4. 用 # 键快速添加**

在Claude Code里按 `#` 键，可以直接添加内容到CLAUDE.md。我经常用这个功能记录临时规则：

```
# 按下 # 键
输入：这个项目用pnpm，不要用npm
# Claude会自动添加到CLAUDE.md
```

---

## 进阶：从CLAUDE.md到MCP Memory

CLAUDE.md解决了"项目级记忆"的问题，但还有一个场景它搞不定：**跨会话的持久记忆**。

比如：
- 你在会话A里发现了一个bug的解决方案
- 下次遇到类似问题，你希望AI能"记住"这个方案

CLAUDE.md做不到，因为它是静态文件，不会自动更新。

> ### MCP Memory Server

这时候可以考虑MCP（Model Context Protocol）的Memory Server。

它的原理是：
1. 把重要信息存储在一个知识图谱（JSON文件）里
2. 每次对话时，根据需要检索相关记忆
3. 支持自动添加、更新、删除记忆

配置示例：

```json
{
  "mcpServers": {
    "memory": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-memory"]
    }
  }
}
```

配置后，你可以对Claude说：

```
记住：这个项目的数据库密码存在 .env.local 里，不要提交到git
```

下次它就会"记住"这个信息，即使是新会话。

> ### 什么时候用哪个？

**固定的项目规范** → CLAUDE.md
**团队共享的规则** → CLAUDE.md（提交到git）
**个人偏好设置** → ~/.claude/CLAUDE.md
**临时但重要的发现** → MCP Memory
**需要持久化的经验** → MCP Memory

我的组合打法：
- **CLAUDE.md**：放不变的规则（代码规范、协作流程）
- **MCP Memory**：放会变的知识（踩坑记录、临时方案）

---

## 我的实践：用CLAUDE.md管理写作项目

说点具体的。我的写作项目用CLAUDE.md管理了半年，分享几个实战经验。

> ### 1. 工作区路由

我的项目有多个工作区：公众号写作、视频创作、Prompt整理。

根目录CLAUDE.md定义了路由规则：

```markdown
收到任务后，先判断属于哪个工作区：
- 提到"公众号""写文章" → 读取 /公众号写作/CLAUDE.md
- 提到"视频""脚本" → 读取 /视频创作/CLAUDE.md
```

这样Claude会根据任务自动加载对应的详细规则，不用我每次指定。

> ### 2. Think Aloud机制

我在CLAUDE.md里强制要求Claude"透明化思考"：

```markdown
## 协作方式
在所有创作过程中，AI需要展示思考过程：
- ✅ "我考虑了A和B两个方案，觉得A更适合，因为..."
- ✅ "我不确定这个数据，让我先搜索验证..."
- ❌ 不要直接给答案而不说明理由
```

效果很明显：Claude的输出从"黑盒"变成了"可审计"。我能看到它的推理过程，随时纠正方向。

> ### 3. 不可妥协的底线

有些规则是"红线"，我用强调语气写在CLAUDE.md里：

```markdown
**不可妥协的核心原则**:
1. ❌ 绝不编造数据
2. ❌ 绝不使用过时信息
3. ❌ 绝不跳过用户确认（重要决策）
```

这些规则的优先级最高，Claude在任何情况下都不会违反。

> ### 4. 迭代优化

CLAUDE.md不是写完就不动了。我大概每周会review一次：

- 删掉不再需要的规则
- 把常用的临时规则固化
- 根据实际问题补充新规则

版本从v1.0迭代到了v3.1，规则从100多行精简到50行。

**Less is More，真的有效。**

---

## 总结：给新手的建议

如果你刚开始用CLAUDE.md，我的建议是：

1. **从最小集开始**：先只写3-5条最核心的规则
2. **观察效果**：看Claude是否按规则执行，不行再调整
3. **逐步迭代**：遇到问题就加规则，冗余了就删规则
4. **分层管理**：通用规则放根目录，专属规则放子目录

记住：CLAUDE.md不是"说明书"，是"协作契约"。

它不是告诉AI"你应该怎么做"，而是告诉AI"我们怎么配合"。

---

**相关资源**：

- [Anthropic官方：Claude Code最佳实践](https://www.anthropic.com/engineering/claude-code-best-practices)
- [CLAUDE.md使用指南（官方）](https://code.claude.com/docs/en/memory)
- [HumanLayer：如何写好CLAUDE.md](https://www.humanlayer.dev/blog/writing-a-good-claude-md)

---

你的CLAUDE.md长什么样？欢迎在评论区分享。
